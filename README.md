# WorkMate - Сервис управления долгими задачами

WorkMate - это HTTP API сервис, разработанный для управления I/O bound задачами, выполнение которых занимает продолжительное время (3-5 минут). Сервис позволяет создавать задачи, отслеживать их статус и получать результаты по завершении.

## Архитектура проекта

Проект построен на принципах чистой архитектуры и разделен на следующие модули:

- **handlers** - обработчики HTTP запросов
- **models** - модели данных
- **routes** - маршрутизация API
- **db** - работа с базой данных
- **tasks** - бизнес-логика асинхронной обработки задач
- **services** - вспомогательные сервисы

### Диаграмма взаимодействия

```
Клиент --> HTTP API --> Обработчики --> Менеджер задач
                                  \
                                   \--> База данных
```

## Предварительные требования

- Go (версия 1.16+)
- PostgreSQL (версия 13+)
- make (опционально)

## Установка и запуск

### 1. Клонирование репозитория

```bash
git clone https://github.com/Hirogava/workmate.git
cd workmate
```

### 2. Настройка базы данных

Создайте базу данных PostgreSQL:

```bash
createdb workmate
```

### 3. Настройка переменных окружения

Создайте файл `.env` в корне проекта:

```env
DB_CONNECTION_STRING="user=postgres password=your_super_secret_password dbname=workmate sslmode=disable"
SERVER_PORT="8080"
```

### 4. Сборка и запуск

```bash
go mod download
go run main.go
```

## API Endpoints

Сервис предоставляет следующие API-эндпоинты:

### Пользователи

#### Создание пользователя

```
POST /user
```

Тело запроса:
```json
{
  "name": "Имя пользователя"
}
```

#### Получение пользователя

```
GET /user/{id}
```

### Задачи

#### Создание задачи

```
POST /task/{userId}
```

Тело запроса:
```json
{
  "task": "Описание задачи"
}
```

#### Получение задачи

```
GET /task/{id}
```

#### Получение всех задач пользователя

```
GET /tasks/{userId}
```

## Примеры использования с Postman

### 1. Создание пользователя

- Метод: `POST`
- URL: `http://localhost:8080/user`
- Заголовки: `Content-Type: application/json`
- Тело:
```json
{
  "name": "Иван Иванов"
}
```

Ответ:
```json
{
  "id": 1,
  "name": "Иван Иванов"
}
```

### 2. Создание задачи

- Метод: `POST`
- URL: `http://localhost:8080/task/1` (где 1 - ID пользователя)
- Заголовки: `Content-Type: application/json`
- Тело:
```json
{
  "task": "Обработка данных"
}
```

Ответ:
```json
{
  "message": "Таск с id 1 создан"
}
```

### 3. Проверка статуса задачи

- Метод: `GET`
- URL: `http://localhost:8080/task/1` (где 1 - ID задачи)

Ответ (задача в процессе):
```json
{
  "id": 1,
  "status": "pending",
  "task": "Обработка данных",
  "result": "",
  "error": "",
  "createdAt": "2023-10-01T14:30:00Z",
  "endedAt": null,
  "userId": 1
}
```

Ответ (задача завершена):
```json
{
  "id": 1,
  "status": "done",
  "task": "Обработка данных",
  "result": "1234567890",
  "error": "",
  "createdAt": "2023-10-01T14:30:00Z",
  "endedAt": "2023-10-01T14:33:00Z",
  "userId": 1
}
```

Ответ (задача завершена с ошибкой):
```json
{
  "id": 1,
  "status": "failed",
  "task": "Обработка данных",
  "result": "error",
  "error": "Описание ошибки",
  "createdAt": "2023-10-01T14:30:00Z",
  "endedAt": "2023-10-01T14:33:00Z",
  "userId": 1
}
```

### 4. Получение всех задач пользователя

- Метод: `GET`
- URL: `http://localhost:8080/tasks/1` (где 1 - ID пользователя)

Ответ:
```json
[
  {
    "id": 1,
    "status": "done",
    "task": "Обработка данных",
    "result": "1234567890",
    "error": "",
    "createdAt": "2023-10-01T14:30:00Z",
    "endedAt": "2023-10-01T14:33:00Z",
    "userId": 1
  },
  {
    "id": 2,
    "status": "pending",
    "task": "Другая задача",
    "result": "",
    "error": "",
    "createdAt": "2023-10-01T15:00:00Z",
    "endedAt": null,
    "userId": 1
  }
]
```

## Расширение функциональности

Для добавления новых типов задач:

1. Создайте обработчик для нового типа задачи в `tasks/manager.go`
2. Обновите маршрутизацию в `routes/apiRoutes.go`
3. При необходимости добавьте новые поля в модель `Task` в `models/tasks_models.go`

## Особенности реализации

1. **Асинхронная обработка**: Задачи выполняются асинхронно, без блокировки HTTP-запросов
2. **Хранение состояния**: Все состояния задач сохраняются в базе данных
3. **Масштабируемость**: Архитектура позволяет легко добавлять новые типы задач
4. **Безопасность**: Валидация входных данных и обработка ошибок
